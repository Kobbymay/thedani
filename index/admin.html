<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Publish Writings</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <script>
        if (localStorage.getItem('isAdmin') !== 'true') {
        window.location.href = 'admin-login.html';
        }
    </script>

    <header class="l-header">
        <nav class="nav bd-grid">
            <div>
                <a href="index.html" class="nav__logo">The DaniEl</a>
            </div>
            <div class="nav__menu" id="nav-menu">
                <ul class="nav__list">
                    <li class="nav__item"><a href="index.html" class="nav__link">Home</a></li>
                    <li class="nav__item"><a href="writings.html" class="nav__link">Writings</a></li>
                    <li class="nav__item"><a href="admin.html" class="nav__link active-link">Admin</a></li>
                </ul>
            </div>
            <button class="nav__toggle" id="nav-toggle" aria-controls="nav-menu" aria-expanded="false" aria-label="Open navigation menu">
                <span class="nav__toggle-bar"></span>
                <span class="nav__toggle-bar"></span>
                <span class="nav__toggle-bar"></span>
            </button>
            <button onclick="localStorage.removeItem('isAdmin');window.location.href='admin-login.html';" class="button admin-logout-btn">Logout</button>
        </nav>
    </header>

    <main class="l-main">
        <section class="writings section" id="admin-writings">
            <h2 class="section-title">Publish a New Writing</h2>
            <div class="writings__form-container">
                <form id="adminWritingForm" class="contact__form">
                    <input type="hidden" id="editIndex">
                    <input type="text" id="adminTitle" class="contact__input" placeholder="Title" required>
                    <textarea id="adminContent" class="contact__input" placeholder="Write your article here..." rows="8" required></textarea>
                    <input type="submit" value="Publish" class="contact__button button">
                </form>
                <p id="adminSuccess" class="admin-success">Article published!</p>
            </div>
            <h2 class="section-title admin-section-title-mt">Manage Writings</h2>
            <div class="writings__container bd-grid" id="admin-writings-list">
                <!-- Articles will be loaded here -->
            </div>
        </section>

        <!-- Contact Messages Section -->        <section class="contacts section" id="admin-contacts">
            <h2 class="section-title">Contact Messages</h2>
            <button id="deleteAllMessagesBtn" class="button admin-delete-all-btn">Delete All</button>
            <div class="contacts__container bd-grid" id="contact-messages">
                <!-- Contact messages will be loaded here -->
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer__title">Daniel</p>
        <p class="footer__copy">&#169; 2025 Daniel. All rights reserved</p>
    </footer>

    <script>    // Fetch and display articles from the backend
    async function renderAdminWritings() {
        const writingsList = document.getElementById('admin-writings-list');
        writingsList.innerHTML = '';
        
        try {
            const response = await fetch('http://localhost:3001/api/articles');
            if (!response.ok) throw new Error('Failed to fetch articles');
            const writings = await response.json();

            if (writings.length === 0) {
                writingsList.innerHTML = '<p style="color:#FFD700;">No articles yet.</p>';
                return;
            }

            writings.forEach((writing, idx) => {
                const div = document.createElement('div');
                div.className = 'writing__item case__item';
                div.innerHTML = `
                    <h3>${writing.title}</h3>
                    <p>${writing.content.replace(/\n/g, '<br>')}</p>
                    <div class="writing__actions">
                        <button class="edit-btn button admin-edit-btn" data-idx="${idx}">Edit</button>
                        <button class="delete-btn button admin-delete-btn" data-idx="${idx}">Delete</button>
                    </div>
                `;
                div.dataset.filename = writing.filename || '';
                div.dataset.title = writing.title;
                div.dataset.content = writing.content;
                writingsList.appendChild(div);
            });
        } catch (err) {
            console.error('Error loading articles:', err);
            writingsList.innerHTML = '<p style="color:#FFD700;">Error loading articles from server.</p>';
        }
    }

    // Fetch and display contact messages from the backend
    async function loadMessages() {
        const grid = document.getElementById('messagesGrid');
        try {
            const res = await fetch('http://localhost:3001/api/contacts');
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const messages = await res.json();
            
            if (!Array.isArray(messages) || messages.length === 0) {
                grid.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No messages</p>';
                return;
            }
            
            grid.innerHTML = '';
            messages.slice().reverse().forEach((msg, idx) => {
                const realIndex = messages.length - 1 - idx;
                const div = document.createElement('div');
                div.className = 'message__item highlight__item';
                div.innerHTML = `
                    <h3>${msg.name}</h3>
                    <p><strong>Email:</strong> ${msg.email}</p>
                    <p>${msg.message}</p>
                    <p style="font-size:0.9em;color:#888;">${new Date(msg.date).toLocaleString()}</p>
                    <button class="delete-contact-btn button" data-idx="${realIndex}" style="background:#b22222;color:#fff;margin-top:0.5rem;">Delete</button>
                `;
                grid.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading messages:', error);
            grid.innerHTML = '<p class="error-message">Failed to load messages. Please try again later.</p>';
        }
    }

    async function deleteMessage(index) {
        if (confirm('Are you sure you want to delete this message?')) {
            try {
                const res = await fetch(`http://localhost:3001/api/contact/${index}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete message');
                await loadMessages();
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message. Please try again.');
            }
        }
    }

    // Restore plain textarea logic for add/edit
    document.getElementById('adminWritingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const title = document.getElementById('adminTitle').value.trim();
        const content = document.getElementById('adminContent').value.trim();
        const editIndex = document.getElementById('editIndex').value;
        let filename = '';
        
        if (!title || !content) {
            alert('Please fill in both title and content fields');
            return;
        }

        if (editIndex !== '') {
            const articleDiv = document.querySelectorAll('.writing__item')[editIndex];
            filename = articleDiv ? articleDiv.dataset.filename : '';
        }

        try {
            if (editIndex !== '' && filename) {
                // Edit mode
                const res = await fetch(`http://localhost:3001/api/articles/${filename}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });
                
                if (!res.ok) throw new Error('Failed to update article');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('adminSuccess').textContent = 'Article updated!';
                    await renderAdminWritings();
                }
            } else {
                // Add mode
                const res = await fetch('http://localhost:3001/api/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });

                if (!res.ok) throw new Error('Failed to publish article');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('adminSuccess').textContent = 'Article published!';
                    await renderAdminWritings();
                }
            }
            
            this.reset();
            document.getElementById('editIndex').value = '';
            document.getElementById('adminSuccess').style.display = 'block';
            setTimeout(() => {
                document.getElementById('adminSuccess').style.display = 'none';
            }, 2000);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save article. Please try again.');
        }
    });

    // Restore edit/delete button event delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn')) {
            const idx = e.target.getAttribute('data-idx');
            const articleDiv = document.querySelectorAll('.writing__item')[idx];
            document.getElementById('adminTitle').value = articleDiv.dataset.title;
            document.getElementById('adminContent').value = articleDiv.dataset.content;
            document.getElementById('editIndex').value = idx;
            document.querySelector('#adminWritingForm input[type="submit"]').value = "Update";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (e.target.classList.contains('delete-btn')) {
            const idx = e.target.getAttribute('data-idx');
            const articleDiv = document.querySelectorAll('.writing__item')[idx];
            const filename = articleDiv ? articleDiv.dataset.filename : '';
            if (filename && confirm('Are you sure you want to delete this article?')) {
                fetch(`http://localhost:3001/api/articles/${filename}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(() => {
                    renderAdminWritings();
                });
            }
        }
    });    // Fetch and display contact messages
    async function loadContactMessages() {
        const container = document.getElementById('contact-messages');
        try {
            const response = await fetch('http://localhost:3001/api/contacts');
            if (!response.ok) throw new Error('Failed to fetch contacts');
            const contacts = await response.json();
            
            if (!Array.isArray(contacts) || contacts.length === 0) {
                container.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No messages</p>';
                return;
            }
            
            container.innerHTML = '';
            contacts.reverse().forEach((contact, idx) => {
                const messageEl = document.createElement('div');
                messageEl.className = 'contact-message';
                messageEl.innerHTML = `
                    <h3>${contact.name}</h3>
                    <p class="contact-email">${contact.email}</p>
                    <p class="contact-text">${contact.message}</p>
                    <p class="contact-date">${new Date(contact.date).toLocaleString()}</p>
                    <button class="delete-contact-btn button" data-idx="${contacts.length - 1 - idx}" style="background:#b22222;color:#fff;margin-top:0.5rem;">Delete</button>
                `;
                container.appendChild(messageEl);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-contact-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const idx = e.target.getAttribute('data-idx');
                    if (confirm('Are you sure you want to delete this message?')) {
                        try {
                            const res = await fetch(`http://localhost:3001/api/contacts/${idx}`, {
                                method: 'DELETE'
                            });
                            if (!res.ok) throw new Error('Failed to delete message');
                            await loadContactMessages(); // Reload messages after deletion
                        } catch (err) {
                            console.error('Error deleting message:', err);
                            alert('Failed to delete message. Please try again.');
                        }
                    }
                });
            });

            // Add event listener for delete all button
            document.getElementById('deleteAllMessagesBtn').addEventListener('click', async () => {
                if (contacts.length === 0) {
                    alert('No messages to delete.');
                    return;
                }
                if (confirm('Are you sure you want to delete all messages? This cannot be undone.')) {
                    try {
                        const deletePromises = contacts.map((_, i) => 
                            fetch(`http://localhost:3001/api/contacts/${i}`, { method: 'DELETE' })
                        );
                        await Promise.all(deletePromises);
                        await loadContactMessages(); // Reload messages after deletion
                    } catch (err) {
                        console.error('Error deleting all messages:', err);
                        alert('Failed to delete all messages. Please try again.');
                    }
                }
            });

        } catch (err) {
            console.error('Error loading contacts:', err);
            container.innerHTML = '<p class="error-message">Failed to load messages. Please try again later.</p>';
        }
    }

    // Load messages when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadContactMessages();
        renderAdminWritings();
        loadMessages();
    });
    </script>
    <script src="assets/js/main.js"></script>
    <script>
    // Ensure menu button works on all pages (for pages with multiple navs or dynamic content)
    document.addEventListener('DOMContentLoaded', function() {
      var navToggle = document.getElementById('nav-toggle');
      var navMenu = document.getElementById('nav-menu');
      if (navToggle && navMenu) {
        navToggle.onclick = function() {
          navMenu.classList.toggle('show');
          // Accessibility: set aria-expanded
          var expanded = navMenu.classList.contains('show');
          navToggle.setAttribute('aria-expanded', expanded);
          navMenu.setAttribute('aria-hidden', !expanded);
        };
        // Close menu with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && navMenu.classList.contains('show')) {
            navMenu.classList.remove('show');
            navToggle.setAttribute('aria-expanded', 'false');
            navMenu.setAttribute('aria-hidden', 'true');
          }
        });
        // Close menu when a link is clicked
        document.querySelectorAll('.nav__link').forEach(function(link) {
          link.addEventListener('click', function() {
            if (window.innerWidth < 768) {
              navMenu.classList.remove('show');
              navToggle.setAttribute('aria-expanded', 'false');
              navMenu.setAttribute('aria-hidden', 'true');
            }
          });
        });
        // Set ARIA attributes for accessibility
        navToggle.setAttribute('aria-controls', 'nav-menu');
        navToggle.setAttribute('aria-expanded', 'false');
        navToggle.setAttribute('aria-label', 'Open navigation menu');
        navMenu.setAttribute('aria-hidden', 'true');
      }
    });
    </script>
  </body>
</html>